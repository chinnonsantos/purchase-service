# PURCHASE MICROSERVICES DEMO

[![Travis build status](https://img.shields.io/travis/chinnonsantos/purchase-service/master?logo=travis)](https://travis-ci.org/chinnonsantos/purchase-service) [![Codecov coverage](https://codecov.io/gh/chinnonsantos/purchase-service/branch/master/graph/badge.svg)](https://codecov.io/gh/chinnonsantos/purchase-service) [![Clojure version](https://img.shields.io/badge/clojure-v1.10.0-blueviolet?logo=clojure)](https://clojure.org/) [![GitHub license](https://img.shields.io/github/license/chinnonsantos/purchase-service?logo=apache)](http://www.apache.org/licenses/) [![Twitter follow](https://img.shields.io/twitter/follow/chinnonsantos?label=follow&style=flat&logo=twitter)](https://twitter.com/intent/follow?screen_name=chinnonsantos) [![Open source Love](https://badges.frapsoft.com/os/v2/open-source.svg?v=103)](https://github.com/ellerbrock/open-source-badges/)

This project deals with a purchase microservice created from the leiningen '[compojure][]' template.

Usinged by [Nudemo mobile app][].

## Prerequisites

You will need [Leiningen][] 2.9.1 or above installed.

**Libraries:**

- [midje][] 1.9.9 (:dev)
- [ring/ring-core][] 1.7.1(:dev)
- [ring/ring-jetty-adapter][] 1.7.1 (:dev)
- [clj-http][] 3.10.0
- [cheshire][] 5.9.0
- [ring-json][] 0.5.0

**Plugins:**

- [lein-midje][] 3.2.1 (:dev)
- [lein-cloverage][] 1.1.2 (:dev)

[compojure]: https://github.com/weavejester/compojure
[leiningen]: https://github.com/technomancy/leiningen
[midje]: https://clojars.org/midje
[ring/ring-core]: https://clojars.org/ring/ring-core
[ring/ring-jetty-adapter]: https://clojars.org/ring/ring-jetty-adapter
[clj-http]: https://clojars.org/clj-http
[cheshire]: https://clojars.org/cheshire
[ring-json]: https://clojars.org/ring/ring-json
[lein-midje]: https://clojars.org/lein-midje
[lein-cloverage]: https://clojars.org/lein-cloverage
[Nudemo mobile app]: https://github.com/chinnonsantos/nudemo/releases

## Running server

To start a web server for the application, run:

    lein ring server-headless

> Default ring port changed from ~~3000~~ to **9002**

## Running tests (TDD)

To test the project, run:

    lein midje

To test the project in development stage, run:

    lein midje :autotest

> Automatically reloading the test with each change

To test only **Unit tests** of the project, run:

    lein midje :filter unit

To test only **Assertion tests** of the project, run:

    lein midje :filter assertion

To check test coverage, run:

    lein cloverage --runner :midje

## E2E Testing

To perform a quick **End-to-End** test on this service (with cURL)

- Check health

      curl http://localhost:9002/

- Get balance

      curl http://localhost:9002/balance/:account-id/

  > The _:account-id_ is an [UUID][] informed when creating registration

[UUID]: https://en.wikipedia.org/wiki/Universally_unique_identifier

- Get purchase list (from account ID)

      curl http://localhost:9002/purchase/from-account/:account-id/?tag=footwear&tag=furniture

  > The _:account-id_ is an [UUID][] informed when creating registration
  > **Filters have not been implemented yet!**

- Get purchase info (purchase details)

      curl http://localhost:9002/purchase/:purchase-id/

  > The _:purchase-id_ is an [UUID][] automatically generated by the service after registration

- Create a purchase

      curl -X POST \
      -d '{"account-id": "8b84c28c-8947-4e67-87d8-68f65ebca105", "type": "income", "value": 300.00, "origin": {"code": 0, "name": "bill payment"}, "tag": ["bill", "prepayment"]}' \
      -H "Content-Type: application/json" \
      localhost:9002/purchase/

- Hitting an invalid route

      curl http://localhost:9002/invalid/

To perform a complete automated **End-to-End** test on this service I recommend use the [Postman][]

[Postman]: https://www.getpostman.com/

## Deployment

To create standalone artifact (.jar)

    lein ring uberjar

To run standalone artifact (need Java JRE)

    java -jar target/purchase-1.0.2.jar

> See all releases of this project [here][]!

[here]: https://github.com/chinnonsantos/purchase-service/releases

## Containerization w/ Docker

This project is available in a containerized form on the **[Docker hub][]** repository.

To running the container with **[Docker][] commands**

    sudo docker network create nudemo-services
    sudo docker run -d --rm --name purchase --net nudemo-services -p 9002:9002 chinnonsantos/purchase-service:1.0.2

To go up the service manually with **[Docker][] commands**

    # Ubuntu eoan -> 19.10
    sudo docker network create nudemo-services
    sudo docker run -it --rm --name purchase --net nudemo-services -p 9002:9002 ubuntu:eoan

    ## Inside the container... (sudo docker attach purchase-service)
    # Updating Ubuntu APT packages
    apt update
    # Installing Wget package
    apt install wget -y
    # Installing OpenJDK 11
    apt install openjdk-11-jre-headless -y && java --version
    # Installing Leiningen
    cd /usr/local/bin && wget https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein && ls
    chmod +x lein && ls && ./lein && lein -v
    # Creating app directory
    mkdir /home/purchase-service

    ## Outside the container... (Ctrl+P and Ctrl+Q)
    # Copying project files to container ('~/Projects/' change to 'YOUR_PROJECT_FOLDER')
    sudo docker cp ~/Projects/purchase-service/src purchase-service:/home/purchase-service/src
    sudo docker cp ~/Projects/purchase-service/project.clj purchase-service:/home/purchase-service

    ## Inside the container... (sudo docker attach purchase-service)
    # Downloading Leiningen project dependencies
    cd /home/purchase-service
    lein deps
    # Create standalone artifact (.jar)
    lein ring uberjar
    # Uninstalling packages and cleaning the system for reduce container size
    apt remove wget -y && apt autoremove -y && apt autoclean -y && apt clean -y
    cp target/purchase-1.0.2.jar .
    rm -rf /var/lib/apt/lists/ /tmp/ /var/tmp/ /root/.lein/ /root/.m2/ /root/.wget-hsts /usr/local/bin/lein /home/purchase-service/project.clj /home/purchase-service/src/ /home/purchase-service/target/ /home/purchase-service/test/
    # Starting service (run standalone artifact)
    java -jar purchase-1.0.2.jar

To go up the service automatically with **[Dockerfile][]**

    sudo docker build -t chinnonsantos/purchase-service:1.0.2 --no-cache .
    sudo docker network create nudemo-services
    sudo docker run -d --rm --name purchase --net nudemo-services -p 9002:9002 chinnonsantos/purchase-service:1.0.2

> See all images of this project [here][1]!

[Docker hub]: https://hub.docker.com/
[Docker]: https://docs.docker.com/
[Dockerfile]: https://docs.docker.com/engine/reference/builder/
[1]: https://hub.docker.com/r/chinnonsantos/purchase-service/tags

## Containerization w/ Docker-compose or Amazon ECS (AWS Fargate)

To set up a local cluster with [Docker-compose][] or a cluster on [Amazon Elastic Container Service (ECS)][] with [AWS Fargate][] for [customer-service][], [account-service][] and [purchase-service][] container images, see the **[NUDEMO SERVICES][]** repository.

[Docker-compose]: https://docs.docker.com/compose/
[Amazon Elastic Container Service (ECS)]: https://aws.amazon.com/pt/ecs/
[AWS Fargate]: https://aws.amazon.com/pt/fargate/
[customer-service]: https://hub.docker.com/r/chinnonsantos/customer-service
[account-service]: https://hub.docker.com/r/chinnonsantos/account-service
[purchase-service]: https://hub.docker.com/r/chinnonsantos/purchase-service
[NUDEMO SERVICES]: https://github.com/chinnonsantos/nudemo-services

## Origin class codes

Code definition by transaction type (named in brazilian portuguese)

- INCOMES
  - 0 => _Novo dispositivo autorizado_
  - 1 => _Pagamento recebido_

- EXPENSES
  - 0 => _Serviços_
  - 1 => _Transporte_
  - 2 => _Supermercado_
  - 3 => _Restaurante_
  - 4 => _Eletrônicos_
  - 5 => _Saúde_
  - 6 => _Outros_

- SYSTEM
  - 0 => _Fatura fechada_

> We **don't** cover **system** messages in this demo!

## License

Copyright © 2019 ~ 2020 | Chinnon Santos | Apache License 2.0
